<pre>
  BIP: 102
  Title: Coin Emission Model (CEM)
  Author: Bitmark Development Team
  Status: Final
  Type: Standards Track
  Created: 2018-06-01
  Activated: Block 450,947
  License: MIT
</pre>

==Abstract==

This document specifies the Coin Emission Model (CEM) activated with Fork 1 at block 450,947. The CEM replaces height-based subsidy calculation with emission-based thresholds and introduces a dynamic scaling factor system that adjusts block rewards based on network hashrate.

==Motivation==

The original height-based reward schedule (BIP-100) had limitations in a multi-algorithm environment:

# '''Unequal Emission''': Faster algorithms could emit more coins
# '''Hashrate Spikes''': Temporary hashrate increases could accelerate emission
# '''Algorithm Imbalance''': Popular algorithms would receive disproportionate rewards

The Coin Emission Model addresses these by:

* Basing reward thresholds on total emitted supply, not block height
* Distributing emission equally across all eight algorithms
* Introducing scaling factors that adjust rewards based on hashrate

==Specification==

===Emission-Based Subsidy===

Post-fork subsidy is determined by total coins emitted, not block height:

<pre>
effective_emitted = NUM_ALGOS * previous_algo_money_supply
</pre>

Where:
* <code>NUM_ALGOS</code> = 8
* <code>previous_algo_money_supply</code> = total supply at last block of same algorithm

====Subsidy Schedule====

{| class="wikitable"
|-
! Emitted (satoshis) !! Base Subsidy (satoshis) !! Base Subsidy (MARKS) !! Note
|-
| 0 - 788,000,000,000,000 || 2,000,000,000 || 20.0 || Q1 H0
|-
| 788T - 1,379T || 1,500,000,000 || 15.0 || Q1 H1
|-
| 1,379T - 1,773T || 1,000,000,000 || 10.0 || Q2 H1
|-
| 1,773T - 2,068.5T || 750,000,000 || 7.5 || Q2 H2
|-
| 2,068.5T - 2,265.5T || 500,000,000 || 5.0 || Q3 H2
|-
| 2,265.5T - 2,413.25T || 375,000,000 || 3.75 || Q3 H3
|-
| 2,413.25T - 2,511.75T || 250,000,000 || 2.5 || Q4 H3
|-
| 2,511.75T - 2,585.625T || 187,500,000 || 1.875 || Q4 H4
|-
| 2,585.625T - 2,634.875T || 125,000,000 || 1.25 || Q5 H4
|-
| 2,634.875T - 2,671.8125T || 93,750,000 || 0.9375 || Q5 H5
|-
| 2,671.8125T - 2,696.4375T || 62,500,000 || 0.625 || Q6 H5
|-
| 2,696.4375T - 2,714.90625T || 46,875,000 || 0.46875 || Q6 H6
|-
| 2,714.90625T - 2,727.21875T || 31,250,000 || 0.3125 || Q7 H6
|-
| ... || ... || ... || Continues to minimum
|}

Where Q = Quartering period, H = Halving period

====Maximum Supply====

<pre>
Total Maximum Emission: 27,579,894.73108 MARKS
                      = 2,757,989,473,108,000 satoshis
</pre>

===Per-Algorithm Distribution===

Each algorithm receives 1/8 of the emission:

<pre>
algorithm_subsidy = base_subsidy / 8
</pre>

With 8 algorithms each targeting 16-minute intervals:
* Each algorithm: ~90 blocks/day
* All algorithms: ~720 blocks/day
* Same total emission rate as pre-fork

===Scaling Factor System (SSF)===

The Subsidy Scaling Factor (SSF) adjusts rewards based on network hashrate:

====Purpose====

* Smooth emission when hashrate varies
* Prevent hashrate spikes from accelerating emission
* Maintain predictable monetary policy

====Calculation====

<pre>
scaled_subsidy = base_subsidy - (base_subsidy * 100,000,000 / scaling_factor) / 2
</pre>

Or equivalently:
<pre>
scaled_subsidy = base_subsidy * (1 - 50,000,000 / scaling_factor)
</pre>

====Update Frequency====

* Scaling factor updates approximately every 90 blocks per algorithm (~24 hours)
* Blocks with <code>BLOCK_VERSION_UPDATE_SSF</code> flag trigger recalculation
* Factor remains constant between update blocks

====Peak Hashrate Tracking====

The scaling factor is derived from:

# Historical peak hashrate (up to 1 year of data)
# Current network hashrate
# Algorithm-specific normalization

====Implementation====

<pre>
if (!scalingFactor) {
    return nFees + baseSubsidy;  // No scaling
}
return nFees + baseSubsidy -
       ((CBigNum(baseSubsidy) * CBigNum(100000000)) / scalingFactor).getuint() / 2;
</pre>

===Block Reward Validation===

Miners must claim exactly the correct subsidy:

<pre>
block_value_needed = GetBlockValue(pindex, nFees, false);
if (block.vtx[0].GetValueOut() > block_value_needed) {
    return state.DoS(100, error("ConnectBlock(): coinbase pays too much"));
}
</pre>

==Implementation==

===Source Code References===

* GetBlockValue function: <code>src/main.cpp:1213-1390</code>
* Emission thresholds: <code>src/main.cpp:1275-1380</code>
* Scaling factor logic: <code>src/main.cpp:1247-1264</code>
* SSF calculation: <code>src/core.cpp</code>

===Key Functions===

{| class="wikitable"
|-
! Function !! File !! Purpose
|-
| GetBlockValue() || main.cpp || Calculate block subsidy
|-
| get_ssf() || core.cpp || Calculate scaling factor
|-
| update_ssf() || pureheader.h || Check if block updates SSF
|-
| get_mpow_ms_correction() || core.cpp || Money supply correction for mPoW
|-
| get_pprev_algo() || core.cpp || Find previous block of same algorithm
|}

==Rationale==

===Why Emission-Based Thresholds?===

Height-based thresholds assume predictable block times. With multiple algorithms and variable hashrates:

* Block production rate varies
* Some algorithms may be faster/slower
* Total emission would be unpredictable

Emission-based thresholds ensure:
* Fixed maximum supply
* Predictable monetary policy
* Fair distribution regardless of algorithm popularity

===Why 8x Multiplier?===

<pre>
effective_emitted = 8 * money_supply
</pre>

This multiplier:
* Divides emission points by 8 (one per algorithm)
* Ensures each algorithm contributes equally
* Maintains original emission curve shape

===Why Scaling Factors?===

Without scaling:
* Hashrate spikes accelerate emission
* Mining profitability varies wildly
* Long-term supply becomes unpredictable

With scaling:
* High hashrate reduces per-block reward
* Low hashrate maintains minimum viability
* Total emission remains on schedule

===Why 24-Hour Update Cycles?===

Updating every ~90 blocks per algorithm (~24 hours):

* Provides stability for miners
* Smooth transitions between rates
* Prevents gaming through rapid hashrate changes
* Aligns with typical mining cycle planning

==Security Considerations==

===Emission Rate Manipulation===

* Scaling factor prevents hashrate-based emission attacks
* Long lookback window (up to 1 year) prevents short-term manipulation
* Multi-algorithm requirement increases attack cost

===Block Reward Validation===

* Nodes reject blocks claiming incorrect subsidy
* Exact subsidy calculation is consensus-critical
* All nodes must use identical calculation

===Floating Point Precision===

* All calculations use integer arithmetic (satoshis)
* BigNum library handles large number operations
* Avoids floating point inconsistencies across platforms

==Backward Compatibility==

This is part of the Fork 1 hard fork (BIP-101). Pre-fork software:

* Uses height-based subsidy calculation
* Does not recognize scaling factors
* Will reject post-fork blocks

==Test Vectors==

===Subsidy Calculation Examples===

{| class="wikitable"
|-
! Money Supply (MARKS) !! Effective Emitted !! Base Subsidy !! Note
|-
| 1,000,000 || 8,000,000,000,000,000 || 20 MARKS || Early post-fork
|-
| 10,000,000 || 80,000,000,000,000,000 || 15 MARKS || After first quartering
|-
| 15,000,000 || 120,000,000,000,000,000 || 10 MARKS || After first halving
|}

===Scaling Factor Examples===

{| class="wikitable"
|-
! Scaling Factor !! Effective Rate !! Notes
|-
| ∞ (no scaling) || 100% || Maximum reward
|-
| 200,000,000 || 75% || Moderate scaling
|-
| 100,000,000 || 50% || Heavy scaling
|}

==Economic Analysis==

===Emission Curve===

The combined halving/quartering schedule produces a smooth emission curve:

<pre>
Year 1-3:   20 → 15 → 10 MARKS (base)
Year 4-6:   7.5 → 5 → 3.75 MARKS
Year 7-9:   2.5 → 1.875 → 1.25 MARKS
...
Final:      Minimum 0.015258 MARKS (after ~40+ years)
</pre>

===Distribution Timeline===

{| class="wikitable"
|-
! Percentage Emitted !! Approximate Timeframe
|-
| 50% || ~6 years from genesis
|-
| 75% || ~12 years from genesis
|-
| 90% || ~20 years from genesis
|-
| 99% || ~35 years from genesis
|}

===Comparison to Bitcoin===

{| class="wikitable"
|-
! Aspect !! Bitmark !! Bitcoin
|-
| Maximum Supply || ~27.58M || 21M
|-
| Halving Interval || 788,000 blocks (~3 years) || 210,000 blocks (~4 years)
|-
| Block Time || 2 minutes || 10 minutes
|-
| Additional Mechanism || Quartering, Scaling || None
|}

==See Also==

* [[bip-0100.mediawiki|BIP-100: Bitmark Original Design]]
* [[bip-0101.mediawiki|BIP-101: Multi-Algorithm Proof-of-Work]]

==References==

* [https://github.com/project-bitmark/bitmark/blob/master/src/main.cpp GetBlockValue Implementation]
* [https://github.com/project-bitmark/bitmark Bitmark Source Code]

==Copyright==

This document is licensed under the MIT License.
